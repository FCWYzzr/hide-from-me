(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=class e{static type=`switch-scene`;type=e.type;switchTo;constructor(e){this.switchTo=e}},t=class e{static type=`audio-change`;type=e.type;soundId;action;end=null;constructor(e,t){this.soundId=e,this.action=t}ended(){return console.assert(this.action==`ONCE`),new Promise(e=>{this.end=e})}};async function n(e){e<=0||await new Promise(t=>setTimeout(t,e))}function r(e,t){return e.startsWith(`rgba`)?`rgba(${e.slice(5,-1).split(`,`).slice(0,3).join(`, `)}, ${t})`:e.startsWith(`rgb`)?`rgba(${e.slice(4,-1)}, ${t})`:`rgba(0, 0, 0, ${t})`}function i(e,t,n,r,i,a,o,s){let c=e-n/2,l=e+n/2,u=t-r/2,d=t+r/2,f=i-o/2,p=i+o/2,m=a-s/2,h=a+s/2;return!(l<f||c>p||d<m||u>h)}var a=class{audioCtx;data;loopingNodes=[];constructor(e,t){this.data=t,this.audioCtx=e}start(e=!1,t=null){let n=this.audioCtx.createBufferSource();n.buffer=this.data,n.loop=e,n.onended=t,e&&this.loopingNodes.push(n),n.connect(this.audioCtx.destination),n.start()}stop(){for(let e of this.loopingNodes)e.stop();this.loopingNodes.splice(0,this.loopingNodes.length)}},o=class{ctx=null;width=0;height=0;frameDuration;tickDuration;running=!1;startScene;currentScene=null;sceneTable=new Map;events=[];engineEventHandlers=new Map;audioContext=new AudioContext;sounds=new Map;images=new Map;constructor(n,r=60,i=40){this.frameDuration=1e3/r,this.tickDuration=1e3/i,this.startScene=n,this.engineEventHandlers.set(e.type,this.switchSceneHandler),this.engineEventHandlers.set(t.type,this.audioChangeHandler)}async loadSoundAsset(e,t=`wav`){let n=await fetch(`${root}/sound/${e}.${t}`).then(e=>e.arrayBuffer());this.sounds.set(e,new a(this.audioContext,await this.audioContext.decodeAudioData(n)))}async loadImageAsset(e,t=`svg`){let n=new Image;return new Promise(r=>{n.onload=async()=>{let t=await createImageBitmap(n);this.images.set(e,t),r()},n.src=`${root}/image/${e}.${t}`})}registerScene(e){this.sceneTable.set(e.name,e)}async startWith(e){this.running=!0,this.width=e.width,this.height=e.height,this.ctx=e.getContext(`2d`),this.currentScene=this.sceneTable.get(this.startScene),await this.currentScene.doActivate(this.emit),this.logicLoop().then(),await this.renderLoop()}stop(){this.running=!1}emit=e=>{this.events.push(e)};async renderLoop(){for(;this.running&&this.ctx;){let e=performance.now()+this.frameDuration;this.ctx.clearRect(0,0,this.width,this.height),this.currentScene?.doRender(this.ctx,this.width,this.height,this.images),await new Promise(e=>requestAnimationFrame(()=>e()));let t=e-performance.now();await n(t)}}async logicLoop(){for(;this.running;){let e=[...this.events];this.events.splice(0,this.events.length);let t=performance.now()+this.tickDuration;await this.currentScene.doHandle({type:`TICK`},this.emit);for(let t of e)this.engineEventHandlers.has(t.type)?await this.engineEventHandlers.get(t.type)(t):await this.currentScene.doHandle(t,this.emit);let n=t-performance.now();n>0&&await new Promise(e=>setTimeout(()=>e(),n))}}switchSceneHandler=async e=>{await this.currentScene.doDeactivate(this.emit),this.events.splice(0,this.events.length),this.currentScene=this.sceneTable.get(e.switchTo),await this.currentScene.doActivate(e=>this.events.push(e))};audioChangeHandler=async e=>{let t=this.sounds.get(e.soundId);switch(e.action){case`LOOP`:case`ONCE`:t.start(e.action==`LOOP`,e.end);break;case`STOP`:t.stop();break}}},s=class{name;entityCounter=0;logicSystems=[];rendererSystems=[];eventHandlers=new Map;constructor(e){this.name=e}async doActivate(e){this.activate(e);for(let t of this.rendererSystems)await t.activate(e);for(let t of this.logicSystems)t.activate(e)}async doDeactivate(e){for(let t of this.logicSystems)t.deactivate(e);for(let t of this.rendererSystems)await t.deactivate(e);this.deactivate(e),this.entityCounter=0}async doHandle(e,t){if(e.type==`TICK`)for(let e of this.logicSystems)await e.update(t);else if(this.eventHandlers.has(e.type))for(let t of this.eventHandlers.get(e.type))await t(e)}async doRender(e,t,n,r){let i=Array.from(this.rendererSystems).sort((e,t)=>e.layer-t.layer);for(let a of i)await a.render(e,t,n,r)}registerSystem(e){this.logicSystems.push(e)}createEntity(){return this.entityCounter++}registerRenderer(e){this.rendererSystems.push(e)}registerHandler(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}},c=class{layer;paused=!1;constructor(e){this.layer=e}async render(e,t,n,r){this.paused||await this.doRender(e,t,n,r)}async activate(e){this.reset(),this.resume()}async deactivate(e){this.pause()}pause(){this.paused=!0}resume(){this.paused=!1}reset(){}},l=class extends c{records=new Map;player;spatial;jumpFrame=0;constructor(e,t){super(10),this.spatial=t,this.player=e}pullRecords(e){let t=this.records.get(e).slice(15);return this.records.clear(),t}reset(){this.records.clear()}async doRender(e,t,n,r){for(let[t,n]of this.player){let{position:i,shape:a}=this.spatial.get(t),[o,s]=i,[c,l]=a,{direction:u,isJumping:d}=n,f=1,p=1;if((d||this.jumpFrame!=0)&&(n.isJumping=!1,f=5e-4*this.jumpFrame**2-.02*this.jumpFrame+1,p=-.001*this.jumpFrame**2+.04*this.jumpFrame+1,this.jumpFrame=(this.jumpFrame+1)%40),u===`LEFT`?(e.save(),e.translate(o,s),e.scale(-f,p),e.drawImage(r.get(`sprite/player`),-c/2,-l/2,c,l),e.restore()):(e.save(),e.translate(o,s),e.scale(f,p),e.drawImage(r.get(`sprite/player`),-c/2,-l/2,c,l),e.restore()),!this.records.has(t))this.records.set(t,[{position:[...i],shape:[...a],scale:[f,p],face:u,repeat:1}]);else{let e=this.records.get(t),n=e[e.length-1];n.position[0]==o&&n.position[1]==s&&n.shape[0]==c&&n.shape[1]==l&&n.scale[0]==f&&n.scale[1]==p&&n.face==u?++n.repeat:e.push({position:[...i],shape:[...a],scale:[f,p],face:u,repeat:1})}}}},u=class extends c{time=0;stars=[];constructor(){super(0);for(let e=0;e<100;e++)this.stars.push({x:Math.random()*1600,y:Math.random()*900,radius:Math.random()*2,speed:Math.random()*.5+.1,alpha:Math.random()*.8+.2})}async doRender(e,t,n,r){this.time+=.01;let i=e.createLinearGradient(0,0,0,n),a=Math.floor(10+10*Math.sin(this.time*.5)),o=Math.floor(15+10*Math.sin(this.time*.5+Math.PI/3)),s=Math.floor(30+20*Math.sin(this.time*.5+2*Math.PI/3)),c=Math.floor(20+15*Math.sin(this.time*.3)),l=Math.floor(30+20*Math.sin(this.time*.3+Math.PI/3)),u=Math.floor(60+30*Math.sin(this.time*.3+2*Math.PI/3));i.addColorStop(0,`rgb(${a}, ${o}, ${s})`),i.addColorStop(1,`rgb(${c}, ${l}, ${u})`),e.fillStyle=i,e.fillRect(0,0,t,n);for(let r of this.stars)r.y-=r.speed,r.y<0&&(r.y=n,r.x=Math.random()*t),r.alpha=.5+.5*Math.sin(this.time*2+r.x*.01),e.beginPath(),e.arc(r.x,r.y,r.radius,0,Math.PI*2),e.fillStyle=`rgba(255, 255, 255, ${r.alpha})`,e.fill()}},d=class e extends c{spatial;color;constructor(e,t){super(20),this.spatial=e,this.color=t}async doRender(t,n,r,i){for(let[n,r]of this.color){let i=this.spatial.get(n);e.doRender(i,t,r)}}static doRender(e,t,n){let{position:r,shape:i}=e,[a,o]=r,[s,c]=i;t.save(),t.fillStyle=n,t.fillRect(a-s/2,o-c/2,s,c),t.restore()}};function f(e,t,n,r,i,a,o,s){return i.add(e),a.set(e,t),o.set(e,n),s.set(e,r),e}function p(e,t,n,r){return n.set(e,t),r.add(e),e}function m(e,t,n,r,i,a){return r.set(e,t),i.set(e,n),a.set(e,{key:null}),e}function h(e,t,n,r,i){return r.set(e,t),i.set(e,n),e}function g(e,t,n,r,i){return n.set(e,t),r.set(e,`#DDDDDD`),i.add(e),e}function _(e,t,n,r,i){return r.set(e,t),i.set(e,n),e}function v(e,t,n,r,i,a,o){return r.set(e,{position:n,shape:[208,117]}),i.set(e,{mapId:null,descText:t}),a.set(e,{key:null}),o.set(e,{content:``,color:`#CCFFCC`,font:`system-ui`,fontSize:35,textAlign:`center`}),e}var y=class e{static type=`control`;type=e.type;action;constructor(e){this.action=e}},b=class e{static type=`collide`;type=e.type;a;b;constructor(e,t){this.a=e,this.b=t}},x=class e{static type=`death`;type=e.type;reason;constructor(e){this.reason=e}},S=class e{static type=`touch-portal`;type=e.type;target;constructor(e){this.target=e}},C=class e{static type=`exit-scene`;type=e.type;nextSceneId;constructor(e){this.nextSceneId=e}},w=class{paused=!1;pause(){this.paused=!0}resume(){this.paused=!1}async update(e){this.paused||await this.doUpdate(e)}activate(e){this.resume()}deactivate(e){this.pause()}},T=class extends w{spatial;velocity;collider;gravity=1;constructor(e,t,n){super(),this.spatial=e,this.velocity=t,this.collider=n}async doUpdate(e){this.handleCollisions(e),this.updateXVelocity(),this.applyGravity(),this.updatePositions(),this.immediateSeparateOverlappingObjects()}applyGravity(){for(let[e,t]of this.velocity)this.collider.has(e)&&(t.velocity[1]+=this.gravity,this.capVelocity(t))}handleCollisions(e){let t=Array.from(this.collider);for(let n=0;n<t.length;n++)for(let r=n+1;r<t.length;r++){let i=t[n],a=t[r];if(!this.velocity.has(i)&&!this.velocity.has(a))continue;let o=this.spatial.get(i),s=this.spatial.get(a);this.predictCollision(i,o,a,s)&&(e(new b(i,a)),this.resolveCollision(i,a))}}immediateSeparateOverlappingObjects(){let e=Array.from(this.collider);for(let t=0;t<e.length;t++)for(let n=t+1;n<e.length;n++){let r=e[t],a=e[n];if(!this.spatial.has(r)||!this.spatial.has(a))continue;let o=this.spatial.get(r),s=this.spatial.get(a);i(o.position[0],o.position[1],o.shape[0],o.shape[1],s.position[0],s.position[1],s.shape[0],s.shape[1])&&this.separateObjects(r,o,a,s)}}predictCollision(e,t,n,r){let a=this.velocity.has(e)?this.velocity.get(e).velocity:[0,0],o=this.velocity.has(n)?this.velocity.get(n).velocity:[0,0],s=[t.position[0]+a[0],t.position[1]+a[1]],c=[r.position[0]+o[0],r.position[1]+o[1]];return i(s[0],s[1],t.shape[0],t.shape[1],c[0],c[1],r.shape[0],r.shape[1])}resolveCollision(e,t){let n=this.spatial.get(e),r=this.spatial.get(t);this.separateObjects(e,n,t,r);let i=this.velocity.has(e),a=this.velocity.has(t),[o,s]=this.calculateCollisionNormal(n,r);if(i&&a){this.resolveElasticCollision(e,t);let n=this.velocity.get(e),r=this.velocity.get(t);Math.abs(s)>Math.abs(o)&&(n.velocity[1]=0,r.velocity[1]=0)}else if(i){let t=this.velocity.get(e);Math.abs(o)>Math.abs(s)?t.velocity[0]=0:t.velocity[1]=0}else if(a){let e=this.velocity.get(t);Math.abs(o)>Math.abs(s)?e.velocity[0]=0:e.velocity[1]=0}}separateObjects(e,t,n,r){let i=r.position[0]-t.position[0],a=r.position[1]-t.position[1],o=t.shape[0]/2,s=t.shape[1]/2,c=r.shape[0]/2,l=r.shape[1]/2,u=o+c,d=s+l,f=u-Math.abs(i),p=d-Math.abs(a),m=.01;if(f>0&&p>0){let o=this.velocity.has(e),s=this.velocity.has(n);if(p<f||f===p&&Math.abs(a)>0){let i=(p+m)*Math.sign(a);o&&s?(t.position[1]-=i/2,r.position[1]+=i/2):o?(t.position[1]-=i,this.velocity.get(e).velocity[1]>0&&a<0&&(t.position[1]=r.position[1]-d-m)):s&&(r.position[1]+=i,this.velocity.get(n).velocity[1]>0&&a>0&&(r.position[1]=t.position[1]+d+m))}else{let e=(f+m)*Math.sign(i);o&&s?(t.position[0]-=e/2,r.position[0]+=e/2):o?t.position[0]-=e:s&&(r.position[0]+=e)}t.position[0]=Math.round(t.position[0]*100)/100,t.position[1]=Math.round(t.position[1]*100)/100,r.position[0]=Math.round(r.position[0]*100)/100,r.position[1]=Math.round(r.position[1]*100)/100}}calculateCollisionNormal(e,t){let n=t.position[0]-e.position[0],r=t.position[1]-e.position[1],i=e.shape[0]/2,a=e.shape[1]/2,o=t.shape[0]/2,s=t.shape[1]/2,c=i+o-Math.abs(n),l=a+s-Math.abs(r);return c<l?[Math.sign(n),0]:[0,Math.sign(r)]}resolveElasticCollision(e,t){let n=this.spatial.get(e),r=this.spatial.get(t),i=this.velocity.get(e),a=this.velocity.get(t),o=n.shape[0]*n.shape[1],s=r.shape[0]*r.shape[1],[c,l]=this.calculateCollisionNormal(n,r),u=a.velocity[0]-i.velocity[0],d=a.velocity[1]-i.velocity[1],f=2*(u*c+d*l)/(o+s);i.velocity[0]+=f*s*c,i.velocity[1]+=f*s*l,a.velocity[0]-=f*o*c,a.velocity[1]-=f*o*l,this.capVelocity(i),this.capVelocity(a)}capVelocity(e){Math.abs(e.velocity[0])>e.maxVelocity&&(e.velocity[0]=Math.sign(e.velocity[0])*e.maxVelocity)}updateXVelocity(){for(let[e,t]of this.velocity)t.velocity[0]+=t.accumulator,this.capVelocity(t),t.velocity[0]*=.9,Math.abs(t.velocity[0])<.01&&(t.velocity[0]=0)}updatePositions(){for(let[e,t]of this.velocity)if(this.spatial.has(e)){let n=this.spatial.get(e);n.position[0]+=t.velocity[0],n.position[1]+=t.velocity[1]}}},E=class extends c{particles=[];constructor(){super(11)}gen(e,t,n={}){let{colors:r=[`#FFFF00`,`#FFA500`,`#FF6347`,`#FF0000`],minCount:i=15,maxCount:a=30,minSize:o=5,maxSize:s=25,minSpeed:c=3,maxSpeed:l=12,minLife:u=40,maxLife:d=100,gravity:f=.2,damping:p=.99}=n,m=Math.floor(Math.random()*(a-i+1))+i;for(let n=0;n<m;n++){let n=Math.random()*(l-c)+c,i=Math.random()*Math.PI*2,a=n*Math.cos(i),m=n*Math.sin(i),h=Math.floor(Math.random()*(d-u+1))+u,g=Math.random()*(s-o)+o,_=r[Math.floor(Math.random()*r.length)],v={x:e,y:t,vx:a,vy:m,life:h,maxLife:h,size:g,color:_};f!==0&&(v.gravity=f),p!==1&&(v.damping=p),this.particles.push(v)}}async doRender(e,t,n,r){this.particles.length!==0&&this.updateAndRenderParticles(e)}updateAndRenderParticles(e){for(let t=this.particles.length-1;t>=0;t--){let n=this.particles[t];n.x+=n.vx,n.y+=n.vy,n.gravity&&(n.vy+=n.gravity),n.damping&&(n.vx*=n.damping,n.vy*=n.damping),n.life--;let r=n.life/n.maxLife;e.save(),e.fillStyle=n.color,e.globalAlpha=r,e.fillRect(n.x-n.size/2,n.y-n.size/2,n.size,n.size),e.restore(),n.life<=0&&this.particles.splice(t,1)}}},D=class extends c{fadeProgress=0;fadeDuration;donePromise=null;doneResolve=null;backgroundColor;constructor(e=60,t=`rgba(0, 0, 0, 1)`){super(50),this.fadeDuration=e,this.backgroundColor=t,this.reset()}done(){return this.donePromise}async doRender(e,t,n,i){if(this.fadeProgress>=1)return;e.save();let a=1-this.fadeProgress;e.fillStyle=r(this.backgroundColor,a),e.fillRect(0,0,t,n),e.restore(),this.fadeProgress+=1/this.fadeDuration,this.fadeProgress>=1&&(this.doneResolve(),this.fadeProgress=1)}reset(){this.fadeProgress=0,this.donePromise=new Promise(e=>{this.doneResolve=e})}},O=class extends c{fadeProgress=0;fadeDuration;backgroundColor;onComplete=null;constructor(e=180,t=`rgba(0, 0, 0, 1)`){super(50),this.fadeDuration=e,this.backgroundColor=t}async start(){return this.resume(),new Promise(e=>{this.onComplete=e})}async doRender(e,t,n,i){e.save();let a=this.fadeProgress;e.fillStyle=r(this.backgroundColor,a),e.fillRect(0,0,t,n),e.restore(),this.fadeProgress+=1/this.fadeDuration,this.fadeProgress>1&&(this.onComplete(),this.fadeProgress=1)}async activate(e){this.reset(),this.pause()}reset(){this.fadeProgress=0}},k=class extends c{dummy;spatial;deathCollider;ticking=!1;constructor(e,t,n){super(10),this.dummy=e,this.spatial=t,this.deathCollider=n}stopTick(){this.ticking=!1}continueTick(){this.ticking=!0}pause(){super.pause(),this.stopTick()}resume(){super.resume(),this.continueTick()}async doRender(e,t,n,r){for(let[t,n]of this.dummy){if(this.ticking&&n.frameIndex<n.records.length&&n.repeat>=n.records[n.frameIndex].repeat&&(++n.frameIndex,n.repeat=0),n.frameIndex>=n.records.length){this.spatial.delete(t),this.deathCollider.delete(t);continue}n.frameIndex==0&&n.repeat==0&&(this.spatial.set(t,{position:n.records[0].position,shape:n.records[0].scale}),this.deathCollider.add(t));let{position:i,shape:a,scale:o,face:s}=n.records[n.frameIndex];this.spatial.get(t).position=i,this.spatial.get(t).shape=a;let[c,l]=i,[u,d]=a,[f,p]=o;s===`LEFT`?(e.save(),e.translate(c,l),e.scale(-f,p),e.globalAlpha=.3,e.drawImage(r.get(`sprite/dummy`),-u/2,-d/2,u,d),e.restore()):(e.save(),e.translate(c,l),e.scale(f,p),e.globalAlpha=.3,e.drawImage(r.get(`sprite/dummy`),-u/2,-d/2,u,d),e.restore()),n.repeat++}}},A=class extends c{deathCollider;spatial;color;constructor(e,t,n){super(10),this.spatial=e,this.color=n,this.deathCollider=t}async doRender(e,t,n,r){for(let t of this.deathCollider){let n=this.spatial.get(t);d.doRender(n,e,this.color)}}},j=class extends c{particles=[];screenWidth;screenHeight;constructor(e=1600,t=900){super(15),this.screenWidth=e,this.screenHeight=t}gen(){let e=Math.floor(Math.random()*51)+50;for(let t=0;t<e;t++)this.generateParticle()}generateParticle(){let e=Math.random()>.5?-10:this.screenWidth+10,t=this.screenHeight*.75,n=this.screenWidth*.5-e,r=0-t,i=Math.sqrt(n*n+r*r);n/=i,r/=i;let a=Math.random()*10+10,o=(Math.random()-.5)*.6,s=a*(n*Math.cos(o)-r*Math.sin(o)),c=a*(n*Math.sin(o)+r*Math.cos(o)),l=Math.floor(Math.random()*40+60),u=Math.random()*30+3,d=Math.random()*360,f=Math.random()*30+70,p=Math.random()*20+60,m=`hsl(${d}, ${f}%, ${p}%)`;this.particles.push({x:e,y:t,vx:s,vy:c,life:l,maxLife:l,size:u,color:m})}async doRender(e,t,n,r){this.particles.length!==0&&(this.screenWidth=t,this.screenHeight=n,this.updateAndRenderParticles(e))}updateAndRenderParticles(e){for(let t=this.particles.length-1;t>=0;t--){let n=this.particles[t];n.x+=n.vx,n.y+=n.vy,n.vy+=.15,n.vx*=.98,n.vy*=.98,n.life--;let r=n.life/n.maxLife;e.save(),e.fillStyle=n.color,e.globalAlpha=r,e.fillRect(n.x,n.y,n.size,n.size),e.restore(),(n.life<=0||n.y>this.screenHeight+50)&&this.particles.splice(t,1)}}},M=class{value;changeListener=[];constructor(e){this.value=e}addListener(e){this.changeListener.push(e)}clearListeners(){this.changeListener.splice(0,this.changeListener.length)}get(){return this.value}set(e){if(e!=this.value){this.value=e;for(let e of this.changeListener)e(this.value,this)}}apply(e){e(this.value);for(let e of this.changeListener)e(this.value,this)}},N=class e extends c{spatial;text;constructor(e,t){super(49),this.spatial=e,this.text=t}async doRender(t,n,r,i){for(let[n,r]of this.text){let i=this.spatial.get(n);e.doRender(i,r,t)}}static doRender(e,t,n){let{position:r}=e,{content:i,font:a,fontSize:o,color:s,textAlign:c=`center`}=t;if(!i)return;n.save(),n.font=`${o}px ${a}`,n.fillStyle=s,n.textAlign=c,n.textBaseline=`middle`;let[l,u]=r;n.fillText(i,l,u),n.restore()}},P=class extends w{spatial;entityGetter;entitySet;onCollider;constructor(e,t,n,r){super(),this.spatial=e,this.entityGetter=t,this.entitySet=n,this.onCollider=r}checkCollision(e,t){return i(e.position[0],e.position[1],e.shape[0],e.shape[1],t.position[0],t.position[1],t.shape[0],t.shape[1])}async doUpdate(e){let t=this.entityGetter(),n=this.spatial.get(t);for(let t of this.entitySet.keys()){let r=this.spatial.get(t);if(this.checkCollision(n,r)){let n=this.onCollider(t);n&&e(n);return}}}},F=class extends c{spatial;image;frameCount=0;rate;frames;constructor(e,t,n=.2,r=60){super(3),this.spatial=e,this.image=t,this.rate=n,this.frames=r}async doRender(e,t,n,r){this.frameCount=(this.frameCount+1)%this.frames;let i=this.frameCount/this.frames,a=1+this.rate*Math.sin(i*Math.PI*2),o=1-this.rate*Math.sin(i*Math.PI*2);for(let[t,n]of this.image.entries()){if(!n.key)continue;let i=this.spatial.get(t),s=r.get(n.key),[c,l]=i.position,[u,d]=i.shape;e.save(),e.translate(c,l),e.scale(a,o),e.drawImage(s,-u/2,-d/2,u,d),e.restore()}}reset(){this.frameCount=0,super.reset()}},I=class extends c{spatial;image;constructor(e,t){super(1),this.spatial=e,this.image=t}async doRender(e,t,n,r){for(let[t,n]of this.image.entries()){if(!n.key)continue;let i=this.spatial.get(t),a=r.get(n.key),[o,s]=i.position,[c,l]=i.shape;e.drawImage(a,o-c/2,s-l/2,c,l)}}},L=class extends c{spatial;image;frameCount=0;frames;color;maxGlowSize;constructor(e,t,n=60,r=`#00ff00`,i=1.5){super(2),this.spatial=e,this.image=t,this.frames=n,this.color=r,this.maxGlowSize=i}async doRender(e,t,n,r){this.frameCount=(this.frameCount+1)%this.frames;let i=this.frameCount/this.frames,a=.5+.3*Math.sin(i*Math.PI*2),o=1+this.maxGlowSize+this.maxGlowSize*Math.sin(i*Math.PI*2);for(let[t,n]of this.image.entries()){if(!n.key)continue;let i=this.spatial.get(t),s=r.get(n.key),[c,l]=i.position,[u,d]=i.shape;e.save(),e.translate(c,l),e.globalAlpha=a,e.shadowBlur=50,e.fillStyle=this.color,e.fillRect(-u/2*o,-d/2*o,u*o,d*o),e.globalAlpha=1,e.drawImage(s,-u/2,-d/2,u,d),e.restore()}}reset(){this.frameCount=0,super.reset()}},R=class n extends s{static NAME=`Menu`;playerEntity=0;selectedMap=null;lastRecord=0;muteControl=!1;ignoreNextCollision=!1;canJump=0;emit=null;physicCollider=new Set;mapSelector=new Map;players=new Map;rectColor=new Map;text=new Map;spatial=new Map;velocity=new Map;image=new Map;availableMapImage=new Map;completedMapImage=new Map;fireworkRenderer;explosionRenderer;fadeOutRenderer;mapList;mapTable=new Map;mapSelectors=[];page=new M(0);mapSetter;constructor(e,t){super(n.NAME),e.forEach(e=>this.mapTable.set(e.name,e)),this.mapList=e,this.mapSetter=t,this.registerHandler(y.type,this.controlHandler),this.registerHandler(b.type,this.collideHandler),this.registerHandler(C.type,this.exitSceneHandler),this.registerHandler(S.type,this.touchPortalHandler),this.registerRenderer(new u),this.registerRenderer(new D),this.registerRenderer(this.fadeOutRenderer=new O),this.registerRenderer(this.fireworkRenderer=new j),this.registerRenderer(new N(this.spatial,this.text)),this.registerRenderer(this.explosionRenderer=new E),this.registerRenderer(new d(this.spatial,this.rectColor)),this.registerRenderer(new I(this.spatial,this.image)),this.registerRenderer(new F(this.spatial,this.availableMapImage,.1,60)),this.registerRenderer(new L(this.spatial,this.completedMapImage,60,`#FFFFFF`,.015)),this.registerRenderer(new l(this.players,this.spatial)),this.registerSystem(new T(this.spatial,this.velocity,this.physicCollider)),this.registerSystem(new P(this.spatial,()=>this.playerEntity,this.mapSelector,e=>{let t=this.mapSelector.get(e).mapId;return t?(this.mapSetter(this.mapTable.get(t)),new S(e)):null})),this.page.addListener(this.switchPage)}switchPage=e=>{console.log(`switch`);let t=this.mapSelectors.length,n=e*t;for(let e=0;e<t;++e){let t=this.mapSelectors[e],r=this.completedMapImage.get(t),i=this.mapSelector.get(t),a=this.text.get(t),o=this.text.get(i.descText);if(n+e>=this.mapList.length){i.mapId=null,r.key=null,o.content=``;continue}let s=this.mapList[n+e];i.mapId=s.name;let c=load(s.name);r.key=s.preview,a.content=`${n+e}-${s.name}`,c>s.target?o.content=`最佳 ${c}`:o.content=`目标 ${s.target}(最佳 ${c})`}};activate(e){if(this.emit=e,this.playerEntity=f(this.createEntity(),{position:[800,780],shape:[90,120]},{velocity:[0,0],maxVelocity:100,accumulator:0},{direction:`RIGHT`,isJumping:!1},this.physicCollider,this.spatial,this.velocity,this.players),g(this.createEntity(),{position:[5,450],shape:[10,900]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[1595,450],shape:[10,900]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[800,5],shape:[1600,10]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[800,895],shape:[1600,10]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[450,650],shape:[250,20]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[1150,650],shape:[250,20]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[800,450],shape:[250,20]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[100,450],shape:[250,20]},this.spatial,this.rectColor,this.physicCollider),g(this.createEntity(),{position:[1500,450],shape:[250,20]},this.spatial,this.rectColor,this.physicCollider),_(this.createEntity(),{position:[200,900-250/2],shape:[200,200]},{key:`fg/control-keyboard-left`},this.spatial,this.image),_(this.createEntity(),{position:[500,900-250/2],shape:[200,200]},{key:`fg/control-keyboard-right`},this.spatial,this.image),_(this.createEntity(),{position:[800,600],shape:[300,500]},{key:`fg/control-keyboard-jump`},this.spatial,this.image),_(this.createEntity(),{position:[1100,900-250/2],shape:[300,200]},{key:`fg/touch-portal`},this.spatial,this.image),_(this.createEntity(),{position:[1450,900-250/2],shape:[300,200]},{key:`fg/run-away`},this.spatial,this.image),this.mapSelectors.push(v(this.createEntity(),h(this.createEntity(),{position:[124,133],shape:[208,100]},{content:``,color:`#EEFFEE`,font:`system-ui`,fontSize:30,textAlign:`center`},this.spatial,this.text),[124,250],this.spatial,this.mapSelector,this.completedMapImage,this.text),v(this.createEntity(),h(this.createEntity(),{position:[800,133],shape:[208,100]},{content:``,color:`#EEFFEE`,font:`system-ui`,fontSize:30,textAlign:`center`},this.spatial,this.text),[800,250],this.spatial,this.mapSelector,this.completedMapImage,this.text),v(this.createEntity(),h(this.createEntity(),{position:[1476,133],shape:[208,100]},{content:``,color:`#EEFFEE`,font:`system-ui`,fontSize:30,textAlign:`center`},this.spatial,this.text),[1476,250],this.spatial,this.mapSelector,this.completedMapImage,this.text)),this.switchPage(this.page.get()),this.selectedMap){let n=load(this.selectedMap.name);n>this.lastRecord&&n>this.selectedMap.target&&(this.fireworkRenderer.gen(),e(new t(`sfx/level-up`,`ONCE`)))}}deactivate(e){this.physicCollider.clear(),this.players.clear(),this.rectColor.clear(),this.text.clear(),this.spatial.clear(),this.velocity.clear(),this.image.clear(),this.muteControl=!1,this.mapSelectors.splice(0,this.mapSelectors.length)}controlHandler=async e=>{if(this.muteControl)return;let n=this.velocity.get(this.playerEntity),r=this.players.get(this.playerEntity);switch(e.action){case`LEFT`:n.accumulator=-2,r.direction=`LEFT`;break;case`RIGHT`:n.accumulator=2,r.direction=`RIGHT`;break;case`JUMP`:this.canJump>0&&(--this.canJump,this.emit(new t(`sfx/jump`,`ONCE`)),n.velocity[1]=-25,r.isJumping=!0,this.ignoreNextCollision=!0);break;case`STOP`:n.accumulator=0;break}};exitSceneHandler=async t=>{this.fadeOutRenderer.start().then(()=>{this.emit(new e(t.nextSceneId))})};collideHandler=async e=>{(e.a==this.playerEntity||e.b==this.playerEntity)&&this.canJump!=1&&(this.ignoreNextCollision?this.ignoreNextCollision=!1:this.canJump=1)};touchPortalHandler=async e=>{let t=e.target,{position:n}=this.spatial.get(t),r=this.mapSelector.get(t),i=this.completedMapImage.get(t);if(!i.key)return;let a=this.text.get(t),o=this.text.get(r.descText);a.content=o.content=``,i.key=null,this.explosionRenderer.gen(...n,{colors:[`#EEFFEE`,`#AAFFAA`,`#FFFF00`,`#141E3C`,`#141E3C`,`#141E3C`],minCount:10,maxCount:30,minSize:25,maxSize:50,minLife:20,maxLife:100}),this.muteControl=!0,this.velocity.get(this.playerEntity).accumulator=0,console.log(`set`),this.lastRecord=load(r.mapId),this.mapSetter(this.mapTable.get(r.mapId)),this.emit(new C(z.NAME))}},z=class n extends s{static NAME=`World`;playerEntity=0;canJump=0;dead=!1;emit=null;currentWaveIdx=0;portalWave=[];physicCollider=new Set;deathCollider=new Set;players=new Map;rectColor=new Map;text=new Map;spatial=new Map;dummies=new Map;portal=new Map;portalImage=new Map;velocity=new Map;playerRenderer;dummyRenderer;fireworkRenderer;explosionRenderer;fadeOutRenderer;map=null;maxRecord=new M(0);record=new M(0);ignoreNextCollision=!1;constructor(){super(n.NAME),this.registerHandler(y.type,this.controlHandler),this.registerHandler(b.type,this.collideHandler),this.registerHandler(x.type,this.deathHandler),this.registerHandler(S.type,this.touchPortalHandler),this.registerHandler(C.type,this.exitSceneHandler),this.registerRenderer(new u),this.registerRenderer(new D),this.registerRenderer(this.fadeOutRenderer=new O),this.registerRenderer(this.fireworkRenderer=new j),this.registerRenderer(this.dummyRenderer=new k(this.dummies,this.spatial,this.deathCollider)),this.registerRenderer(new N(this.spatial,this.text)),this.registerRenderer(this.explosionRenderer=new E),this.registerRenderer(new d(this.spatial,this.rectColor)),this.registerRenderer(new F(this.spatial,this.portalImage)),this.registerRenderer(this.playerRenderer=new l(this.players,this.spatial)),window.dev&&this.registerRenderer(new A(this.spatial,this.deathCollider,`#FF0000AA`));let e=()=>this.playerEntity;this.registerSystem(new T(this.spatial,this.velocity,this.physicCollider)),this.registerSystem(new P(this.spatial,e,this.deathCollider,e=>new x(e))),this.registerSystem(new P(this.spatial,e,this.portal,e=>new S(e)))}setMap=e=>{this.map=e};activate(e){console.assert(this.map!=null),this.record.set(0),this.maxRecord.set(load(this.map.name)),this.emit=e,this.dead=!1,p(this.createEntity(),{position:[800,1e3],shape:[1800,20]},this.spatial,this.deathCollider),p(this.createEntity(),{position:[800,-100],shape:[1800,20]},this.spatial,this.deathCollider),p(this.createEntity(),{position:[-100,450],shape:[20,1100]},this.spatial,this.deathCollider),p(this.createEntity(),{position:[1700,450],shape:[20,1100]},this.spatial,this.deathCollider);let n={content:`[${this.map.name}]  ${this.record.get()} (Best ${this.maxRecord.get()})`,font:`EF-Dot`,color:`skyblue`,fontSize:50,textAlign:`center`};h(this.createEntity(),{position:[800,70],shape:[100,50]},n,this.spatial,this.text),this.record.addListener(r=>{r>this.maxRecord.get()?(e(new t(`sfx/level-up`,`ONCE`)),this.maxRecord.set(r),this.fireworkRenderer.gen()):(n.content=`[${this.map.name}]  ${r} (Best ${this.maxRecord.get()})`,e(new t(`sfx/check`,`ONCE`)))}),this.maxRecord.addListener(e=>{n.content=`[${this.map.name}]  ${this.record.get()} (Best ${e})`,save(this.map.name,e)}),this.loadMap(),this.activateNextWave(),e(new t(`bgm/world`,`LOOP`))}deactivate(e){e(new t(`bgm/world`,`STOP`)),this.maxRecord.clearListeners(),this.record.clearListeners(),this.portalWave.splice(0,this.portalWave.length),this.spatial.clear(),this.dummies.clear(),this.physicCollider.clear(),this.deathCollider.clear(),this.portal.clear(),this.velocity.clear(),this.text.clear()}loadMap(){let{player:e,obstacles:t,portalWaves:n}=this.map,[r,i,a=90,o=120]=e;this.playerEntity=f(this.createEntity(),{position:[r,i],shape:[a,o]},{velocity:[0,0],maxVelocity:100,accumulator:0},{direction:`RIGHT`,isJumping:!1},this.physicCollider,this.spatial,this.velocity,this.players);for(let[e,n,r,i]of t)g(this.createEntity(),{position:[e,n],shape:[r,i]},this.spatial,this.rectColor,this.physicCollider);for(let e of n){let t=[];for(let n of e){let e=m(this.createEntity(),{position:[...n],shape:[120,120]},{enable:!1},this.spatial,this.portal,this.portalImage);t.push(e)}this.portalWave.push(t)}}activateNextWave(){let e=Math.floor(Math.random()*this.portalWave.length);e==this.currentWaveIdx?this.currentWaveIdx=(e+1)%this.portalWave.length:this.currentWaveIdx=e;for(let e of this.portalWave[this.currentWaveIdx])this.portal.get(e).enable=!0,this.portalImage.get(e).key=`sprite/portal`}controlHandler=async e=>{let n=this.velocity.get(this.playerEntity),r=this.players.get(this.playerEntity);switch(e.action){case`LEFT`:n.accumulator=-2,r.direction=`LEFT`;break;case`RIGHT`:n.accumulator=2,r.direction=`RIGHT`;break;case`JUMP`:this.canJump>0&&(--this.canJump,this.emit(new t(`sfx/jump`,`ONCE`)),n.velocity[1]=-25,r.isJumping=!0);break;case`STOP`:n.accumulator=0;break}};collideHandler=async e=>{(e.a==this.playerEntity||e.b==this.playerEntity)&&this.canJump!=2&&(this.ignoreNextCollision?this.ignoreNextCollision=!1:(console.log(`reset`),this.canJump=2))};deathHandler=async e=>{if(this.dead)return;this.dead=!0,this.playerRenderer.pause(),this.dummyRenderer.stopTick(),this.emit(new t(`bgm/world`,`STOP`));let n=this.velocity.get(this.playerEntity);n.velocity[0]=0,n.accumulator=0,(async()=>{let e=new t(`sfx/death`,`ONCE`);this.emit(e),await e.ended();let n=new t(`sfx/fail`,`ONCE`);this.emit(n),await n.ended()})().then();let r=this.spatial.get(this.playerEntity)?.position;r&&this.explosionRenderer&&this.explosionRenderer.gen(r[0],r[1],{colors:[`#FFFF00`,`#FF0000`],minCount:4,maxCount:8,minSize:30,maxSize:40,minSpeed:10,maxSpeed:15,minLife:60,maxLife:120,gravity:.2,damping:.99}),this.emit(new C(R.NAME))};touchPortalHandler=async e=>{if(!this.dead&&this.portal.get(e.target).enable){this.portalImage.get(e.target).key=null,this.portal.get(e.target).enable=!1,this.playerRenderer.pause(),this.record.set(this.record.get()+1);for(let e of this.portalWave[this.currentWaveIdx]){let t=this.spatial.get(e).position;this.explosionRenderer.gen(t[0],t[1],{colors:[`#353a1F`,`#3F3F07`,`#afaf40`],minCount:30,maxCount:60,minSize:6,maxSize:25,minSpeed:3,maxSpeed:10,minLife:50,maxLife:100,gravity:.1,damping:.98})}this.dummyRenderer.pause();for(let e of this.portalWave[this.currentWaveIdx])this.portal.get(e).enable=!1,this.portalImage.get(e).key=null;this.activateNextWave();for(let[e,t]of this.dummies)this.spatial.delete(e),this.deathCollider.delete(e),t.frameIndex=t.repeat=0;this.dummies.set(this.createEntity(),{records:this.playerRenderer.pullRecords(this.playerEntity),frameIndex:0,repeat:0}),this.dummyRenderer.resume(),this.playerRenderer.resume()}};exitSceneHandler=async t=>{this.fadeOutRenderer.start().then(()=>{this.emit(new e(t.nextSceneId))})}};function*B(e){let t=new z;yield t,yield new R(e,t.setMap)}async function V(){let e=JSON.parse(localStorage.getItem(`hide-from-me-save`)??`{}`);window.save=(t,n)=>{e[t]=n,localStorage.setItem(`hide-from-me-save`,JSON.stringify(e))},window.load=t=>e[t]??0,window.dev&&(window.clearSave=()=>{Object.assign(e,{})})}async function H(e){let{sound:t,image:n,maps:r}=await fetch(`${root}/assets.json`).then(e=>e.json()),i=[];for(let t in n)i.push(e.loadImageAsset(t,n[t]));for(let n in t)i.push(e.loadSoundAsset(n,t[n]));return await Promise.all(i),await Promise.all(r.map(async e=>await(await fetch(`${root}/maps/${e}.json`)).json()))}async function U(e){let t=new o(R.NAME),n=await H(t);for(let e of B(n))t.registerScene(e);let r=-1,i=-1;function a(){r!=-1&&i!=-1?t.emit(new y(`JUMP`)):r==-1?i==-1?t.emit(new y(`STOP`)):t.emit(new y(`RIGHT`)):t.emit(new y(`LEFT`))}function s(t){let n=t,{width:o,height:s}=e.getBoundingClientRect(),c=o>s;switch(t.type){case`touchstart`:for(let e of n.targetTouches)c&&e.clientX>o/2||!c&&e.clientY>s/2?i=e.identifier:(c&&e.clientX<o/2||!c&&e.clientY<s/2)&&(r=e.identifier);break;case`touchend`:case`touchcancel`:for(let e of n.changedTouches)r==e.identifier?r=-1:i==e.identifier&&(i=-1);break}a(),t.preventDefault()}function c(e){let n=e;if(!n.repeat){switch(n.key.toLowerCase()){case`arrowright`:case`d`:i=1;break;case`arrowleft`:case`a`:r=1;break;case` `:case`w`:case`arrowup`:t.emit(new y(`JUMP`));break}a()}}function l(e){let t=e;if(!t.repeat){switch(t.key.toLowerCase()){case`arrowright`:case`d`:i=-1;break;case`arrowleft`:case`a`:r=-1;break}a()}}window.addEventListener(`keydown`,c),window.addEventListener(`keyup`,l),e.addEventListener(`touchstart`,s,!1),e.addEventListener(`touchend`,s,!1),window.dev&&(window.kill=()=>{t.emit(new x(-1))},window.engine=()=>t),await t.startWith(e),window.removeEventListener(`keydown`,c),window.removeEventListener(`keyup`,l),window.removeEventListener(`touchstart`,s),window.removeEventListener(`touchend`,s),window.removeEventListener(`touchcancel`,s),t.stop()}async function W(e){await V(),await U(e)}window.root=`/hide-from-me`,W(document.querySelector(`#app`)).then();