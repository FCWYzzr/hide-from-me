(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=class e{static type=`switch`;type=e.type;switchTo;constructor(e){this.switchTo=e}},t=class{canvas=null;ctx=null;width=0;height=0;frameDuration;tickDuration;running=!1;currentScene=null;sceneTable=new Map;events=[];constructor(e=60,t=40){this.frameDuration=1e3/e,this.tickDuration=1e3/t}registerScene(e){this.sceneTable.set(e.name,e)}async switchScene(e){await this.currentScene.doDeactivate(),this.events.splice(0,this.events.length),this.currentScene=this.sceneTable.get(e),await this.currentScene.doActivate(e=>this.events.push(e))}async startWith(e){this.running=!0,this.canvas=e,this.width=this.canvas.width,this.height=this.canvas.height,this.ctx=e.getContext(`2d`),this.currentScene=this.sceneTable.get(`World`),await this.currentScene.doActivate(e=>this.events.push(e)),this.logicLoop().then(),await this.renderLoop()}stop(){this.running=!1}emit(e){this.events.push(e)}async renderLoop(){for(;this.running&&this.ctx;){let e=performance.now()+this.frameDuration;this.ctx.clearRect(0,0,this.width,this.height),this.currentScene?.doRender(this.ctx,this.width,this.height),await new Promise(e=>requestAnimationFrame(()=>e())),requestAnimationFrame(()=>{});let t=e-performance.now();t>0&&await new Promise(e=>setTimeout(()=>e(),t))}}async logicLoop(){for(;this.running;){let t=[...this.events];this.events.splice(0,this.events.length);let n=performance.now()+this.tickDuration;await this.currentScene.doHandle({type:`TICK`},e=>this.events.push(e));for(let n of t){if(n.type==e.type){await this.switchScene(n.switchTo);break}await this.currentScene.doHandle(n,e=>this.events.push(e))}let r=n-performance.now();r>0&&await new Promise(e=>setTimeout(()=>e(),r))}}},n=class{name;systems=[];entityCounter=0;renderers=[];eventHandlers=new Map;constructor(e){this.name=e}async doActivate(e){this.activate(e);for(let e of this.renderers)e.reset&&e.reset(),e.resume&&e.resume();for(let e of this.systems)e.resume()}async doDeactivate(){for(let e of this.systems)e.pause();for(let e of this.renderers)e.pause&&e.pause();this.deactivate(),this.entityCounter=0}async doHandle(e,t){if(e.type==`TICK`)for(let e of this.systems)await e.update(t);else if(this.eventHandlers.has(e.type))for(let t of this.eventHandlers.get(e.type))await t(e)}async doRender(e,t,n){let r=Array.from(this.renderers).sort((e,t)=>e.layer-t.layer);for(let i of r)await i.render(e,t,n)}registerSystem(e){this.systems.push(e)}createEntity(){return this.entityCounter++}registerRenderer(e){this.renderers.push(e)}registerHandler(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}},r=`/assets/jump-CQyE2Eqp.wav`,i=`/assets/glass-shatter-8ekkAxX9.wav`,a=`/assets/fail-CHBv77uc.wav`,o=`/assets/check-CffJtiPy.wav`,s=`/assets/bgm-D_GAN0yn.wav`,c=`/assets/level-up-Cyz5wLk6.wav`,l=`data:image/svg+xml,%3csvg%20viewBox='0%200%2030%2040'%20xmlns='http://www.w3.org/2000/svg'%20version='1.1'%3e%3crect%20width='30'%20height='40'%20rx='2'%20ry='2'%20fill='%23999900'%20stroke='%2399990055'%20stroke-width='2'/%3e%3crect%20x='22'%20y='5'%20width='4'%20height='10'%20rx='2'%20fill='black'/%3e%3crect%20x='13'%20y='5'%20width='4'%20height='10'%20rx='2'%20fill='black'/%3e%3c/svg%3e`,u=`data:image/svg+xml,%3csvg%20viewBox='0%200%2030%2040'%20xmlns='http://www.w3.org/2000/svg'%20version='1.1'%3e%3crect%20width='30'%20height='40'%20rx='2'%20ry='2'%20fill='%23FFFF00'%20stroke='%23FFFF0055'%20stroke-width='2'/%3e%3crect%20x='22'%20y='5'%20width='4'%20height='10'%20rx='2'%20fill='black'/%3e%3crect%20x='13'%20y='5'%20width='4'%20height='10'%20rx='2'%20fill='black'/%3e%3c/svg%3e`,d={name:`Playground`,player:[100,130],obstacles:[[800,830,1500,40]],infiniteWave:!0,portalWaves:[[[1400,750]],[[400,750]]]},f=`/assets/10Pixel-Regular-Jwf3kFRP.otf`;const p=new Audio;p.src=r;const m=new Audio;m.src=i;const h=new Audio;h.src=a;const g=new Audio;g.src=o;const _=new Audio;_.src=c;const v=new Audio;v.src=s,v.loop=!0,v.volume*=.3;const y=new Image;y.src=l;const b=new Image;b.src=u;const x=d,S=f;var C=class{layer=10;records=new Map;player;spatial;jumpFrame=0;paused=!1;constructor(e,t){this.spatial=t,this.player=e}pullRecords(e){let t=this.records.get(e).slice(10);return this.records.clear(),t}pause(){this.paused=!0}resume(){this.paused=!1}reset(){this.records.clear()}async render(e,t,n){if(!this.paused)for(let[t,n]of this.player){let{position:r,shape:i}=this.spatial.get(t),[a,o]=r,[s,c]=i,{direction:l,isJumping:u}=n,d=1,f=1;if((u||this.jumpFrame!=0)&&(n.isJumping=!1,d=5e-4*this.jumpFrame**2-.02*this.jumpFrame+1,f=-.001*this.jumpFrame**2+.04*this.jumpFrame+1,this.jumpFrame=(this.jumpFrame+1)%40),l===`LEFT`?(e.save(),e.translate(a,o),e.scale(-d,f),e.drawImage(b,-s/2,-c/2,s,c),e.restore()):(e.save(),e.translate(a,o),e.scale(d,f),e.drawImage(b,-s/2,-c/2,s,c),e.restore()),!this.records.has(t))this.records.set(t,[{position:[...r],shape:[...i],scale:[d,f],face:l,repeat:1}]);else{let e=this.records.get(t),n=e[e.length-1];n.position[0]==a&&n.position[1]==o&&n.shape[0]==s&&n.shape[1]==c&&n.scale[0]==d&&n.scale[1]==f&&n.face==l?++n.repeat:e.push({position:[...r],shape:[...i],scale:[d,f],face:l,repeat:1})}}}},w=class{layer=0;time=0;stars=[];constructor(){for(let e=0;e<100;e++)this.stars.push({x:Math.random()*1600,y:Math.random()*900,radius:Math.random()*2,speed:Math.random()*.5+.1,alpha:Math.random()*.8+.2})}async render(e,t,n){this.time+=.01;let r=e.createLinearGradient(0,0,0,n),i=Math.floor(10+10*Math.sin(this.time*.5)),a=Math.floor(15+10*Math.sin(this.time*.5+Math.PI/3)),o=Math.floor(30+20*Math.sin(this.time*.5+2*Math.PI/3)),s=Math.floor(20+15*Math.sin(this.time*.3)),c=Math.floor(30+20*Math.sin(this.time*.3+Math.PI/3)),l=Math.floor(60+30*Math.sin(this.time*.3+2*Math.PI/3));r.addColorStop(0,`rgb(${i}, ${a}, ${o})`),r.addColorStop(1,`rgb(${s}, ${c}, ${l})`),e.fillStyle=r,e.fillRect(0,0,t,n);for(let r of this.stars)r.y-=r.speed,r.y<0&&(r.y=n,r.x=Math.random()*t),r.alpha=.5+.5*Math.sin(this.time*2+r.x*.01),e.beginPath(),e.arc(r.x,r.y,r.radius,0,Math.PI*2),e.fillStyle=`rgba(255, 255, 255, ${r.alpha})`,e.fill()}},T=class e{layer=1;spatial;color;constructor(e,t){this.spatial=e,this.color=t}async render(t,n,r){for(let[n,r]of this.color){let i=this.spatial.get(n);e.doRender(i,t,r)}}static doRender(e,t,n){let{position:r,shape:i}=e,[a,o]=r,[s,c]=i;t.save(),t.fillStyle=n,t.fillRect(a-s/2,o-c/2,s,c),t.restore()}},E=`data:image/svg+xml,%3csvg%20viewBox='0%200%2040%2040'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='5'%20y='5'%20width='30'%20height='30'%20fill='%23353a1F50'%20stroke-width='1'%20stroke='%23FFFF00'/%3e%3crect%20x='10'%20y='10'%20width='20'%20height='20'%20fill='%233F3F0790'%20/%3e%3crect%20x='15'%20y='15'%20width='10'%20height='10'%20fill='%23afaf40F0'%20/%3e%3c/svg%3e`,D=new Image;D.src=E;var O=class{layer=9;spatial;portal;frameCount=0;constructor(e,t){this.spatial=e,this.portal=t}async render(e,t,n){for(let[t,n]of this.portal){if(!n.enable)continue;let{position:r,shape:i}=this.spatial.get(t),[a,o]=r,[s,c]=i;this.frameCount=(this.frameCount+1)%30;let l=this.frameCount/30,u=1+.2*Math.sin(l*Math.PI*2),d=1-.2*Math.sin(l*Math.PI*2);e.save(),e.translate(a,o),e.scale(u,d),e.drawImage(D,-s/2,-c/2,s,c),e.restore()}}};function k(e,t,n,r,i,a,o,s){return i.add(e),a.set(e,t),o.set(e,n),s.set(e,r),e}function A(e,t,n,r){return n.set(e,t),r.add(e),e}function j(e,t,n,r,i){return r.set(e,t),i.set(e,n),e}function M(e,t,n,r,i){return r.set(e,t),i.set(e,n),e}var N=class e{static type=`control`;type=e.type;action;constructor(e){this.action=e}},P=class e{static type=`collide`;type=e.type;a;b;constructor(e,t){this.a=e,this.b=t}},F=class e{static type=`death`;type=e.type;reason;constructor(e){this.reason=e}},I=class e{static type=`touch-portal`;type=e.type},L=class e{static type=`new-record`;type=e.type},R=class{paused=!1;pause(){this.paused=!0}resume(){this.paused=!1}async update(e){this.paused||await this.doUpdate(e)}};function z(e,t){return e.startsWith(`rgba`)?`rgba(${e.slice(5,-1).split(`,`).slice(0,3).join(`, `)}, ${t})`:e.startsWith(`rgb`)?`rgba(${e.slice(4,-1)}, ${t})`:`rgba(0, 0, 0, ${t})`}function B(e,t,n,r,i,a,o,s){let c=e-n/2,l=e+n/2,u=t-r/2,d=t+r/2,f=i-o/2,p=i+o/2,m=a-s/2,h=a+s/2;return!(l<f||c>p||d<m||u>h)}var V=class extends R{spatial;velocity;collider;gravity=1;constructor(e,t,n){super(),this.spatial=e,this.velocity=t,this.collider=n}async activate(e){}async deactivate(){}async doUpdate(e){this.updateXVelocity(),this.applyGravity(),this.updatePositions(),this.immediateSeparateOverlappingObjects(),this.handleCollisions(e)}applyGravity(){for(let[e,t]of this.velocity)this.collider.has(e)&&(t.velocity[1]+=this.gravity,this.capVelocity(t))}handleCollisions(e){let t=Array.from(this.collider);for(let n=0;n<t.length;n++)for(let r=n+1;r<t.length;r++){let i=t[n],a=t[r];if(!this.spatial.has(i)||!this.spatial.has(a))continue;let o=this.spatial.get(i),s=this.spatial.get(a);this.predictCollision(i,o,a,s)&&(e(new P(i,a)),this.resolveCollision(i,a))}}immediateSeparateOverlappingObjects(){let e=Array.from(this.collider);for(let t=0;t<e.length;t++)for(let n=t+1;n<e.length;n++){let r=e[t],i=e[n];if(!this.spatial.has(r)||!this.spatial.has(i))continue;let a=this.spatial.get(r),o=this.spatial.get(i);B(a.position[0],a.position[1],a.shape[0],a.shape[1],o.position[0],o.position[1],o.shape[0],o.shape[1])&&this.separateObjects(r,a,i,o)}}predictCollision(e,t,n,r){let i=this.velocity.has(e)?this.velocity.get(e).velocity:[0,0],a=this.velocity.has(n)?this.velocity.get(n).velocity:[0,0],o=[t.position[0]+i[0],t.position[1]+i[1]],s=[r.position[0]+a[0],r.position[1]+a[1]];return B(o[0],o[1],t.shape[0],t.shape[1],s[0],s[1],r.shape[0],r.shape[1])}resolveCollision(e,t){let n=this.spatial.get(e),r=this.spatial.get(t);this.separateObjects(e,n,t,r);let i=this.velocity.has(e),a=this.velocity.has(t),[o,s]=this.calculateCollisionNormal(n,r);if(i&&a){this.resolveElasticCollision(e,t);let n=this.velocity.get(e),r=this.velocity.get(t);Math.abs(s)>Math.abs(o)&&(n.velocity[1]=0,r.velocity[1]=0)}else if(i){let t=this.velocity.get(e);Math.abs(o)>Math.abs(s)?t.velocity[0]=0:t.velocity[1]=0}else if(a){let e=this.velocity.get(t);Math.abs(o)>Math.abs(s)?e.velocity[0]=0:e.velocity[1]=0}}separateObjects(e,t,n,r){let i=r.position[0]-t.position[0],a=r.position[1]-t.position[1],o=t.shape[0]/2,s=t.shape[1]/2,c=r.shape[0]/2,l=r.shape[1]/2,u=o+c,d=s+l,f=u-Math.abs(i),p=d-Math.abs(a),m=.01;if(f>0&&p>0){let o=this.velocity.has(e),s=this.velocity.has(n);if(p<f||f===p&&Math.abs(a)>0){let i=(p+m)*Math.sign(a);o&&s?(t.position[1]-=i/2,r.position[1]+=i/2):o?(t.position[1]-=i,this.velocity.get(e).velocity[1]>0&&a<0&&(t.position[1]=r.position[1]-d-m)):s&&(r.position[1]+=i,this.velocity.get(n).velocity[1]>0&&a>0&&(r.position[1]=t.position[1]+d+m))}else{let e=(f+m)*Math.sign(i);o&&s?(t.position[0]-=e/2,r.position[0]+=e/2):o?t.position[0]-=e:s&&(r.position[0]+=e)}t.position[0]=Math.round(t.position[0]*100)/100,t.position[1]=Math.round(t.position[1]*100)/100,r.position[0]=Math.round(r.position[0]*100)/100,r.position[1]=Math.round(r.position[1]*100)/100}}calculateCollisionNormal(e,t){let n=t.position[0]-e.position[0],r=t.position[1]-e.position[1],i=e.shape[0]/2,a=e.shape[1]/2,o=t.shape[0]/2,s=t.shape[1]/2,c=i+o-Math.abs(n),l=a+s-Math.abs(r);return c<l?[Math.sign(n),0]:[0,Math.sign(r)]}resolveElasticCollision(e,t){let n=this.spatial.get(e),r=this.spatial.get(t),i=this.velocity.get(e),a=this.velocity.get(t),o=n.shape[0]*n.shape[1],s=r.shape[0]*r.shape[1],[c,l]=this.calculateCollisionNormal(n,r),u=a.velocity[0]-i.velocity[0],d=a.velocity[1]-i.velocity[1],f=2*(u*c+d*l)/(o+s);i.velocity[0]+=f*s*c,i.velocity[1]+=f*s*l,a.velocity[0]-=f*o*c,a.velocity[1]-=f*o*l,this.capVelocity(i),this.capVelocity(a)}capVelocity(e){Math.abs(e.velocity[0])>e.maxVelocity&&(e.velocity[0]=Math.sign(e.velocity[0])*e.maxVelocity)}updateXVelocity(){for(let[e,t]of this.velocity)t.velocity[0]+=t.accumulator,this.capVelocity(t),t.velocity[0]*=.9,Math.abs(t.velocity[0])<.01&&(t.velocity[0]=0)}updatePositions(){for(let[e,t]of this.velocity)if(this.spatial.has(e)){let n=this.spatial.get(e);n.position[0]+=t.velocity[0],n.position[1]+=t.velocity[1]}}},H=class extends R{spatial;deathCollider;playerEntityGetter;constructor(e,t,n){super(),this.spatial=e,this.deathCollider=t,this.playerEntityGetter=n}async activate(e){}async deactivate(){}async doUpdate(e){let t=this.playerEntityGetter(),n=this.spatial.get(t);for(let t of this.deathCollider){let r=this.spatial.get(t);if(this.checkAABBCollision(n.position[0],n.position[1],n.shape[0],n.shape[1],r.position[0],r.position[1],r.shape[0],r.shape[1])){e(new F(t));break}}}checkAABBCollision(e,t,n,r,i,a,o,s){let c=e-n/2,l=e+n/2,u=t-r/2,d=t+r/2,f=i-o/2,p=i+o/2,m=a-s/2,h=a+s/2;return!(l<f||c>p||d<m||u>h)}},U=class extends R{spatial;portal;playerEntityGetter;constructor(e,t,n){super(),this.spatial=e,this.portal=t,this.playerEntityGetter=n}async activate(e){}async deactivate(){}async doUpdate(e){let t=this.playerEntityGetter(),n=this.spatial.get(t);for(let[t,r]of this.portal){if(!r.enable)continue;let i=this.spatial.get(t),a=n.position[0]-n.shape[0]/2,o=n.position[0]+n.shape[0]/2,s=n.position[1]-n.shape[1]/2,c=n.position[1]+n.shape[1]/2,l=i.position[0],u=i.position[1];if(l>=a&&l<=o&&u>=s&&u<=c){e(new I),this.portal.get(t).enable=!1;return}}}},W=class{layer=20;particles=[];gen(e,t,n={}){let{colors:r=[`#FFFF00`,`#FFA500`,`#FF6347`,`#FF0000`],minCount:i=15,maxCount:a=30,minSize:o=5,maxSize:s=25,minSpeed:c=3,maxSpeed:l=12,minLife:u=40,maxLife:d=100,gravity:f=.2,damping:p=.99}=n,m=Math.floor(Math.random()*(a-i+1))+i;for(let n=0;n<m;n++){let n=Math.random()*(l-c)+c,i=Math.random()*Math.PI*2,a=n*Math.cos(i),m=n*Math.sin(i),h=Math.floor(Math.random()*(d-u+1))+u,g=Math.random()*(s-o)+o,_=r[Math.floor(Math.random()*r.length)],v={x:e,y:t,vx:a,vy:m,life:h,maxLife:h,size:g,color:_};f!==0&&(v.gravity=f),p!==1&&(v.damping=p),this.particles.push(v)}}async render(e,t,n){this.particles.length!==0&&this.updateAndRenderParticles(e)}updateAndRenderParticles(e){for(let t=this.particles.length-1;t>=0;t--){let n=this.particles[t];n.x+=n.vx,n.y+=n.vy,n.gravity&&(n.vy+=n.gravity),n.damping&&(n.vx*=n.damping,n.vy*=n.damping),n.life--;let r=n.life/n.maxLife;e.save(),e.fillStyle=n.color,e.globalAlpha=r,e.fillRect(n.x-n.size/2,n.y-n.size/2,n.size,n.size),e.restore(),n.life<=0&&this.particles.splice(t,1)}}},G=class{layer=100;fadeProgress=0;fadeDuration;isDone=!1;backgroundColor;constructor(e=60,t=`rgba(0, 0, 0, 1)`){this.fadeDuration=e,this.backgroundColor=t}async render(e,t,n){if(this.isDone)return;e.save();let r=1-this.fadeProgress;e.fillStyle=z(this.backgroundColor,r),e.fillRect(0,0,t,n),e.restore(),this.fadeProgress+=1/this.fadeDuration,this.fadeProgress>=1&&(this.isDone=!0,this.fadeProgress=1)}reset(){this.fadeProgress=0,this.isDone=!1}},K=class{layer=100;fadeProgress=0;fadeDuration;isStarted=!1;backgroundColor;onComplete=null;constructor(e=180,t=`rgba(0, 0, 0, 1)`){this.fadeDuration=e,this.backgroundColor=t}async activate(){return this.isStarted=!0,new Promise(e=>{this.onComplete=e})}async render(e,t,n){if(!this.isStarted||this.fadeProgress>=1){this.onComplete&&=(this.onComplete(),null);return}e.save();let r=this.fadeProgress;e.fillStyle=z(this.backgroundColor,r),e.fillRect(0,0,t,n),e.restore(),this.fadeProgress+=1/this.fadeDuration,this.fadeProgress>1&&(this.fadeProgress=1)}reset(){this.fadeProgress=0,this.isStarted=!1}},q=class{layer=9;dummy;spatial;deathCollider;paused=!1;constructor(e,t,n){this.dummy=e,this.spatial=t,this.deathCollider=n}pause(){this.paused=!0}resume(){this.paused=!1}async render(e,t,n){for(let[t,n]of this.dummy){if(this.paused||n.frameIndex<n.records.length&&n.repeat==n.records[n.frameIndex].repeat&&(++n.frameIndex,n.repeat=0),n.frameIndex>=n.records.length){this.spatial.delete(t),this.deathCollider.delete(t);continue}n.frameIndex==0&&n.repeat==0&&(this.spatial.set(t,{position:n.records[0].position,shape:n.records[0].scale}),this.deathCollider.add(t));let{position:r,shape:i,scale:a,face:o}=n.records[n.frameIndex];this.spatial.get(t).position=r,this.spatial.get(t).shape=i;let[s,c]=r,[l,u]=i,[d,f]=a;o===`LEFT`?(e.save(),e.translate(s,c),e.scale(-d,f),e.globalAlpha=.3,e.drawImage(y,-l/2,-u/2,l,u),e.restore()):(e.save(),e.translate(s,c),e.scale(d,f),e.globalAlpha=.3,e.drawImage(y,-l/2,-u/2,l,u),e.restore()),n.repeat++}}},J=class{layer=99;deathCollider;spatial;color;constructor(e,t,n){this.spatial=e,this.color=n,this.deathCollider=t}async render(e,t,n){for(let t of this.deathCollider){let n=this.spatial.get(t);T.doRender(n,e,this.color)}}},Y=class{layer=15;particles=[];screenWidth;screenHeight;constructor(e=1600,t=900){this.screenWidth=e,this.screenHeight=t}activate(){let e=Math.floor(Math.random()*51)+50;for(let t=0;t<e;t++)this.generateParticle()}generateParticle(){let e=Math.random()>.5?-10:this.screenWidth+10,t=this.screenHeight*.75,n=this.screenWidth*.5-e,r=0-t,i=Math.sqrt(n*n+r*r);n/=i,r/=i;let a=Math.random()*10+10,o=(Math.random()-.5)*.6,s=a*(n*Math.cos(o)-r*Math.sin(o)),c=a*(n*Math.sin(o)+r*Math.cos(o)),l=Math.floor(Math.random()*40+60),u=Math.random()*30+3,d=Math.random()*360,f=Math.random()*30+70,p=Math.random()*20+60,m=`hsl(${d}, ${f}%, ${p}%)`;this.particles.push({x:e,y:t,vx:s,vy:c,life:l,maxLife:l,size:u,color:m})}async render(e,t,n){this.particles.length!==0&&(this.screenWidth=t,this.screenHeight=n,this.updateAndRenderParticles(e))}updateAndRenderParticles(e){for(let t=this.particles.length-1;t>=0;t--){let n=this.particles[t];n.x+=n.vx,n.y+=n.vy,n.vy+=.15,n.vx*=.98,n.vy*=.98,n.life--;let r=n.life/n.maxLife;e.save(),e.fillStyle=n.color,e.globalAlpha=r,e.fillRect(n.x,n.y,n.size,n.size),e.restore(),(n.life<=0||n.y>this.screenHeight+50)&&this.particles.splice(t,1)}}},X=class{value;changeListener=[];constructor(e){this.value=e}addListener(e){this.changeListener.push(e)}clearListeners(){this.changeListener.splice(0,this.changeListener.length)}get(){return this.value}set(e){if(e!=this.value){this.value=e;for(let e of this.changeListener)e(this.value,this)}}apply(e){e(this.value);for(let e of this.changeListener)e(this.value,this)}},Z=class e{layer=99;spatial;text;constructor(e,t){this.spatial=e,this.text=t}async render(t,n,r){for(let[n,r]of this.text){let i=this.spatial.get(n);e.doRender(i,r,t)}}static doRender(e,t,n){let{position:r}=e,{content:i,font:a,fontSize:o,color:s,textAlign:c=`center`}=t;n.save(),n.font=`${o}px ${a}`,n.fillStyle=s,n.textAlign=c,n.textBaseline=`middle`;let[l,u]=r;n.fillText(i,l,u),n.restore()}},Q=class t extends n{static name=`World`;playerEntity=0;scoreBoardEntity=0;mayJump=0;dead=!1;emit=null;currentWaveIdx=0;portalWave=[];physicCollider=new Set;deathCollider=new Set;players=new Map;rectColor=new Map;text=new Map;spatial=new Map;dummies=new Map;portal=new Map;velocity=new Map;playerRenderer;dummyRenderer;fireworkRenderer;explosionRenderer;fadeOutRenderer;map=x;maxRecord=new X(0);record=new X(0);constructor(){super(t.name),this.registerHandler(N.type,this.controlHandler),this.registerHandler(P.type,this.collideHandler),this.registerHandler(F.type,this.deathHandler),this.registerHandler(I.type,this.touchPortalHandler),this.registerHandler(L.type,this.newRecordHandler),this.registerRenderer(new w),this.registerRenderer(new G),this.registerRenderer(this.fadeOutRenderer=new K),this.registerRenderer(this.fireworkRenderer=new Y),this.registerRenderer(this.dummyRenderer=new q(this.dummies,this.spatial,this.deathCollider)),this.registerRenderer(new Z(this.spatial,this.text)),this.registerRenderer(this.explosionRenderer=new W),this.registerRenderer(new T(this.spatial,this.rectColor)),this.registerRenderer(new O(this.spatial,this.portal)),this.registerRenderer(this.playerRenderer=new C(this.players,this.spatial)),window.dev&&this.registerRenderer(new J(this.spatial,this.deathCollider,`#FF0000AA`)),this.registerSystem(new V(this.spatial,this.velocity,this.physicCollider)),this.registerSystem(new H(this.spatial,this.deathCollider,()=>this.playerEntity)),this.registerSystem(new U(this.spatial,this.portal,()=>this.playerEntity))}mapName(){return this.map.name}async changeMap(n){this.map=n,await this.fadeOutRenderer.activate(),this.emit(new e(t.name))}activate(e){this.record.set(0),this.maxRecord.set(load(this.mapName())),v.currentTime=0,v.play().then(),this.emit=e,this.dead=!1,A(this.createEntity(),{position:[800,1e3],shape:[1800,20]},this.spatial,this.deathCollider),A(this.createEntity(),{position:[800,-100],shape:[1800,20]},this.spatial,this.deathCollider),A(this.createEntity(),{position:[-100,450],shape:[20,1100]},this.spatial,this.deathCollider),A(this.createEntity(),{position:[1700,450],shape:[20,1100]},this.spatial,this.deathCollider),this.scoreBoardEntity=M(this.createEntity(),{position:[800,70],shape:[100,50]},{content:`[${this.mapName()}]  ${this.record.get()} (Best ${this.maxRecord.get()})`,font:`EF-Dot`,color:`skyblue`,fontSize:50,textAlign:`center`},this.spatial,this.text),this.record.addListener(e=>{e>this.maxRecord.get()?(_.play().then(),this.maxRecord.set(e),this.fireworkRenderer.activate()):(this.text.get(this.scoreBoardEntity).content=`[${this.mapName()}]  ${e} (Best ${this.maxRecord.get()})`,g.play().then())}),this.maxRecord.addListener(e=>{this.text.get(this.scoreBoardEntity).content=`[${this.mapName()}]  ${this.record.get()} (Best ${e})`,save(this.mapName(),e)}),this.loadMap(),this.activateNextWave()}deactivate(){v.pause(),this.maxRecord.clearListeners(),this.record.clearListeners(),this.portalWave.splice(0,this.portalWave.length),this.spatial.clear(),this.dummies.clear(),this.physicCollider.clear(),this.deathCollider.clear(),this.portal.clear(),this.velocity.clear(),this.text.clear()}loadMap(){let{player:e,obstacles:t,portalWaves:n}=this.map;this.playerEntity=k(this.createEntity(),{position:[...e],shape:[90,120]},{velocity:[0,0],maxVelocity:100,accumulator:0},{direction:`RIGHT`,isJumping:!1},this.physicCollider,this.spatial,this.velocity,this.players);for(let[e,n,r,i]of t){let t=this.createEntity();this.spatial.set(t,{position:[e,n],shape:[r,i]}),this.physicCollider.add(t),this.rectColor.set(t,`#FFFFFFAA`)}for(let e of n){let t=[];for(let n of e){let e=j(this.createEntity(),{position:[...n],shape:[120,120]},{enable:!1},this.spatial,this.portal);t.push(e)}this.portalWave.push(t)}}activateNextWave(){if(this.map.infiniteWave){let e=Math.floor(Math.random()*this.portalWave.length);this.currentWaveIdx==e&&(e=(e+1)%this.portalWave.length),this.currentWaveIdx=e}for(let e of this.portalWave[this.currentWaveIdx])this.portal.get(e).enable=!0}controlHandler=async e=>{let t=this.velocity.get(this.playerEntity),n=this.players.get(this.playerEntity);switch(e.action){case`LEFT`:t.accumulator=-2,n.direction=`LEFT`;break;case`RIGHT`:t.accumulator=2,n.direction=`RIGHT`;break;case`JUMP`:this.mayJump>0&&(--this.mayJump,p.play().then(),t.velocity[1]=-25,n.isJumping=!0);break;case`STOP`:t.accumulator=0;break}};collideHandler=async e=>{(e.a==this.playerEntity||e.b==this.playerEntity)&&!this.players.get(this.playerEntity).isJumping&&(this.mayJump=2)};deathHandler=async n=>{if(this.dead)return;this.dead=!0,this.playerRenderer.pause(),this.dummyRenderer.pause(),v.pause(),m.onended=()=>{h.play()},await m.play();let r=this.spatial.get(this.playerEntity)?.position;r&&this.explosionRenderer&&this.explosionRenderer.gen(r[0],r[1],{colors:[`#FFFF00`,`#FF0000`],minCount:4,maxCount:8,minSize:30,maxSize:40,minSpeed:10,maxSpeed:15,minLife:60,maxLife:120,gravity:.2,damping:.99}),await this.fadeOutRenderer.activate(),this.emit(new e(t.name))};touchPortalHandler=async e=>{this.playerRenderer.pause(),this.record.set(this.record.get()+1);for(let e of this.portalWave[this.currentWaveIdx]){let t=this.spatial.get(e).position;this.explosionRenderer.gen(t[0],t[1],{colors:[`#353a1F`,`#3F3F07`,`#afaf40`],minCount:30,maxCount:60,minSize:6,maxSize:25,minSpeed:3,maxSpeed:10,minLife:50,maxLife:100,gravity:.1,damping:.98})}this.dummyRenderer.pause();for(let e of this.portalWave[this.currentWaveIdx])this.portal.get(e).enable=!1;if(this.map.infiniteWave||this.portalWave.shift(),this.portalWave.length!=0){this.activateNextWave();for(let[e,t]of this.dummies)this.spatial.delete(e),this.deathCollider.delete(e),t.frameIndex=t.repeat=0;this.dummies.set(this.createEntity(),{records:this.playerRenderer.pullRecords(this.playerEntity),frameIndex:0,repeat:0}),this.dummyRenderer.resume(),this.playerRenderer.resume()}};newRecordHandler=async e=>{this.fireworkRenderer.activate()}};function*$(){yield new Q}async function ee(){let e=JSON.parse(localStorage.getItem(`hide-from-me-save`)??`{}`);window.save=(t,n)=>{e[t]=n,localStorage.setItem(`hide-from-me-save`,JSON.stringify(e))},window.load=t=>e[t]??0}async function te(){return await new FontFace(`EF-Dot`,`url(${S})`).load()}async function ne(e){console.log(`start engine`);let n=new t(120,40);for(let e of $())n.registerScene(e);let r=-1,i=-1;function a(t){let a=t,{width:o,height:s}=e.getBoundingClientRect(),c=o>s;switch(t.type){case`touchstart`:for(let e of a.targetTouches)c&&e.clientX>o/2||!c&&e.clientY>s/2?i=e.identifier:(c&&e.clientX<o/2||!c&&e.clientY<s/2)&&(r=e.identifier);break;case`touchend`:case`touchcancel`:for(let e of a.changedTouches)r==e.identifier?r=-1:i==e.identifier&&(i=-1);break}r!=-1&&i!=-1?n.emit(new N(`JUMP`)):r==-1?i==-1?n.emit(new N(`STOP`)):n.emit(new N(`RIGHT`)):n.emit(new N(`LEFT`)),t.preventDefault()}function o(e){let t=e;if(!t.repeat)switch(t.key.toLowerCase()){case`arrowright`:case`d`:n.emit(new N(`RIGHT`));break;case`arrowleft`:case`a`:n.emit(new N(`LEFT`));break;case` `:case`arrowup`:n.emit(new N(`JUMP`));break}}function s(e){let t=e;if(!t.repeat)switch(t.key.toLowerCase()){case`arrowright`:case`arrowleft`:case`a`:case`d`:n.emit(new N(`STOP`));break}}window.addEventListener(`keydown`,o),window.addEventListener(`keyup`,s),e.addEventListener(`touchstart`,a,!1),e.addEventListener(`touchend`,a,!1),window.dev&&(window.kill=()=>{n.emit(new F(-1))},window.newRecord=()=>{n.emit(new L)},window.engine=()=>n),await n.startWith(e),window.removeEventListener(`keydown`,o),window.removeEventListener(`keyup`,s),window.removeEventListener(`touchstart`,a),window.removeEventListener(`touchend`,a),window.removeEventListener(`touchcancel`,a),n.stop()}async function re(e){await ee(),await te(),await ne(e)}re(document.querySelector(`#app`)).then();